# Copilot API with Traefik Load Balancer

This project provides a straightforward way to run multiple instances of the `copilot-api` service, load-balanced by Traefik. It uses a dynamic configuration approach where a Python script generates the `docker-compose.yaml` file based on your GitHub token configurations.

## Prerequisites

*   **Docker & Docker Compose:** Ensure Docker and Docker Compose are installed on your system.
*   **Python 3:** Required for the script that generates the Docker Compose configuration.
*   **GitHub Tokens:** You'll need valid GitHub tokens for each `copilot-api` instance you want to run.

## Getting Started

1.  **Clone the Repository:**
    ```bash
    git clone https://github.com/nghyane/cursor-copilot-proxy.git
    cd cursor-copilot-proxy
    ```

2.  **Configure GitHub Tokens:**
    Create a `tokens.json` file in the root of the project by copying `tokens.json.example`:
    ```bash
    cp tokens.json.example tokens.json
    ```
    Edit `tokens.json` to include your GitHub tokens. Each entry will create a separate `copilot-api` service instance:
    ```json
    [
      {
        "name": "service1",
        "token": "your_github_token_for_service1"
      },
      {
        "name": "service2",
        "token": "your_github_token_for_service2"
      }
    ]
    ```
    *   The `name` field will be used to identify the service and should be unique.
    *   The `token` field is your GitHub token.

3.  **Generate Docker Compose Configuration:**
    Run the Python script to generate the `docker-compose.yaml` file:
    ```bash
    python3 generate.py
    ```
    This script reads `tokens.json` and uses `templates/docker-compose.yaml.j2` to create `docker-compose.yaml`.

4.  **Start Services:**
    Launch Traefik and the `copilot-api` services using Docker Compose:
    ```bash
    docker compose up -d
    ```

## Usage

*   **API Endpoint:** Your load-balanced `copilot-api` will be accessible at `http://localhost/`. Traefik will distribute requests among the running `copilot-api` instances.
*   **Traefik Dashboard:** Monitor and manage Traefik at `http://localhost:8080/dashboard/`.

## Configuration

### Adding or Removing API Instances

1.  Modify the `tokens.json` file to add, remove, or update service entries.
2.  Re-run the `generate.py` script:
    ```bash
    python3 generate.py
    ```
3.  Restart your Docker Compose services:
    ```bash
    docker compose up -d --force-recreate
    ```
    Traefik will automatically detect the changes.

### Key Files

*   `tokens.json`: Your GitHub token configurations. **Do not commit this file to version control.**
*   `generate.py`: Python script to generate `docker-compose.yaml`.
*   `templates/docker-compose.yaml.j2`: Jinja2 template for the Docker Compose configuration.
*   `docker-compose.yaml`: The generated Docker Compose file (auto-generated by `generate.py`).
*   `traefik/rr.yml`: Traefik round-robin load balancing configuration.

## SSL/HTTPS

This setup is designed for HTTP on the server-side (port 80). For HTTPS, it's recommended to use a reverse proxy like Cloudflare in front of Traefik. Cloudflare can handle SSL termination, simplifying the server-side configuration.

**Using with Cloudflare:**
1.  Point your domain's DNS records to your server, with Cloudflare proxy enabled (orange cloud).
2.  Set Cloudflare's SSL/TLS encryption mode to "Flexible" or "Full".
3.  Access your API via HTTPS through your domain.

## Security

*   **IMPORTANT:** The `tokens.json` file contains sensitive GitHub tokens. Ensure this file is listed in your `.gitignore` and is never committed to your repository. The provided `.gitignore` should already cover this.
*   Review file permissions, especially for `tokens.json`.

## Troubleshooting

*   **Traefik Dashboard Inaccessible:** Ensure port 8080 is not blocked by a firewall.
*   **API Not Working:**
    *   Check Docker logs for Traefik and your `copilot-api` services: `docker compose logs traefik` and `docker compose logs <service_name>`.
    *   Verify that `tokens.json` is correctly formatted and `generate.py` ran without errors.
    *   Ensure `docker-compose.yaml` was generated and looks correct.
*   **GitHub Token Issues:** Ensure your GitHub tokens are valid and have the necessary permissions.
